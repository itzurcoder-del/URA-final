<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>URA â€” Chat with memory</title>
<style>
  :root{
    --bg:#f4f7fb; --panel:#fff; --muted:#6b7280; --accent:#06b6d4; --bot:#22c55e; --user:#0ea5e9;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial;margin:0;height:100vh;background:var(--bg);color:#111;display:flex;overflow:hidden}
  /* Sidebar */
  #sidebar{width:300px;background:var(--panel);box-shadow:2px 0 18px rgba(12,12,12,0.06);padding:14px;display:flex;flex-direction:column;gap:12px}
  #brand{font-weight:700;font-size:16px}
  #chatsList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .chat-item{padding:10px;border-radius:12px;cursor:pointer;color:#111;background:transparent;display:flex;justify-content:space-between;align-items:center}
  .chat-item.active{background:#edf7ff}
  .chat-item .meta{font-size:12px;color:var(--muted)}
  #newChat{padding:8px;border-radius:10px;border:1px dashed #e6eef6;background:transparent;cursor:pointer}
  #sidebar .muted{color:var(--muted);font-size:13px}
  #controls-wrap{display:flex;gap:8px}
  #signinBtn,#signoutBtn{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#000;cursor:pointer}
  #signoutBtn{background:#ef4444;color:#fff}
  #searchInput{width:100%;padding:8px;border-radius:8px;border:1px solid #eee}
  /* Main area */
  #main{flex:1;display:flex;flex-direction:column}
  header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;background:transparent}
  header h1{margin:0;font-size:18px}
  #chat{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:72%;padding:12px 16px;border-radius:var(--radius);word-wrap:break-word;line-height:1.45;position:relative;box-shadow:0 6px 18px rgba(0,0,0,0.03)}
  .msg.user{align-self:flex-end;background:var(--user);color:#000;border-bottom-right-radius:8px}
  .msg.bot{align-self:flex-start;background:var(--bot);color:#fff;border-bottom-left-radius:8px}
  .msg .meta{font-size:12px;color:rgba(255,255,255,0.8);margin-top:8px}
  .msg-controls{margin-top:8px;display:flex;gap:8px}
  .msg-controls button{padding:6px 8px;border-radius:8px;border:none;background:#fff;color:#111;cursor:pointer}
  .controls{display:flex;gap:10px;padding:12px;border-top:1px solid #e6eef6;align-items:center;background:transparent}
  textarea{flex:1;height:52px;padding:12px;border-radius:999px;border:1px solid #e6eef6;outline:none;resize:none}
  button.primary{background:var(--accent);color:#000;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
  button.icon{width:44px;height:44px;border-radius:50%;background:#fff;border:1px solid #e6eef6;cursor:pointer}
  select, #themeToggle{padding:6px 10px;border-radius:8px;border:none;background:var(--panel);color:var(--muted)}
  /* thinking animation */
  .thinking {
    display:inline-block;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,0.14);color:#fff; margin-bottom:6px;
  }
  .dots span{display:inline-block;width:6px;height:6px;margin:0 3px;border-radius:50%;background:#fff;opacity:.35;transform:translateY(0);
    animation: bounce 1s infinite;}
  .dots span:nth-child(2){animation-delay:.15s}
  .dots span:nth-child(3){animation-delay:.3s}
  @keyframes bounce {50%{opacity:1;transform:translateY(-6px)}}
  /* modal */
  #loginModal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:999}
  #loginCard{background:#fff;padding:20px;border-radius:12px;max-width:420px;width:92%;box-shadow:0 14px 50px rgba(0,0,0,0.18)}
  /* responsive */
  @media(max-width:900px){
    #sidebar{display:none}
    .msg{max-width:92%}
    #chat{padding:12px}
  }
</style>
</head>
<body>

  <!-- Sidebar -->
  <div id="sidebar">
    <div id="brand">URA â€” Chats</div>

    <div style="display:flex;align-items:center;gap:8px">
      <input id="searchInput" placeholder="Search chats..." />
      <button id="newChat">+ New</button>
    </div>

    <div id="chatsList"></div>

    <div id="controls-wrap">
      <button id="signinBtn">Sign in with Google</button>
      <button id="signoutBtn" style="display:none">Sign out</button>
    </div>

    <div class="muted" style="font-size:13px">Signed in: <span id="userEmail">not signed</span></div>
  </div>

  <!-- Main -->
  <div id="main">
    <header>
      <h1>URA â€” Your assistant</h1>
      <div style="display:flex;align-items:center;gap:12px">
        <label class="muted">Voice:</label>
        <select id="voiceSelect"></select>
        <button id="themeToggle">ðŸŒ™</button>
      </div>
    </header>

    <div id="chat"></div>

    <div class="controls">
      <button id="micBtn" class="icon" title="Speak">ðŸŽ¤</button>
      <textarea id="input" placeholder="Type your message... (Press Enter)"></textarea>
      <button id="send" class="primary">Send</button>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginModal" style="display:none">
    <div id="loginCard">
      <h3>Sign in to save your chats</h3>
      <p class="muted">Sign in with Google to store chat history across devices. If you skip, memory will reset on refresh.</p>
      <div style="display:flex;gap:8px;margin-top:14px">
        <button id="modalSignIn" style="flex:1;background:var(--accent);border:none;padding:10px;border-radius:8px">Sign in with Google</button>
        <button id="modalSkip" style="flex:1;background:#f3f4f6;border:none;padding:10px;border-radius:8px">Skip</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* =========================
   CONFIG â€” edit these:
   - set firebaseConfig with your Firebase web config
   - no GROQ key here (serverless holds it)
   - set MODEL name in Vercel env if needed
*/
const firebaseConfig = {
  apiKey: "AIzaSyAfbJJEw61oIaMKUIFMGVK062g376dSrXI",
  authDomain: "ura-ai-b1b20.firebaseapp.com",
  projectId: "ura-ai-b1b20",
  storageBucket: "ura-ai-b1b20.firebasestorage.app",
  messagingSenderId: "330104435643",
  appId: "1:330104435643:web:6f1d6f338a2e0de6cb0a9e"
};
// end config

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// UI refs
const chatsListEl = document.getElementById("chatsList");
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");
const micBtn = document.getElementById("micBtn");
const signInBtn = document.getElementById("signinBtn");
const signOutBtn = document.getElementById("signoutBtn");
const userEmailEl = document.getElementById("userEmail");
const modal = document.getElementById("loginModal");
const modalSignIn = document.getElementById("modalSignIn");
const modalSkip = document.getElementById("modalSkip");
const newChatBtn = document.getElementById("newChat");
const voiceSelect = document.getElementById("voiceSelect");
const searchInput = document.getElementById("searchInput");
const themeToggle = document.getElementById("themeToggle");

// state
let user = null;
let chats = []; // sidebar meta {id, title, updatedAt}
let activeChatId = null;
let activeMessages = []; // messages [{role,text,ts}]
let localMode = { chats: [] };

// voices
let voices = [];
function loadVoices(){ voices = speechSynthesis.getVoices() || []; voiceSelect.innerHTML = voices.map((v,i)=>`<option value="${i}">${v.name} - ${v.lang}</option>`).join(''); }
speechSynthesis.onvoiceschanged = loadVoices;
setTimeout(loadVoices,500);

// helpers
function formatHtml(t){ return t.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>").replace(/\n/g,'<br>'); }
function formatTime(ts){
  const d = new Date(ts);
  return d.toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'});
}
function clearChat(){ chatEl.innerHTML = ''; }
function scrollChat(){ chatEl.scrollTop = chatEl.scrollHeight - chatEl.clientHeight + 200; }

// render messages
function renderMessages(list){
  clearChat();
  list.forEach(m=>{
    const d = document.createElement('div');
    d.className = 'msg ' + (m.role==='user' ? 'user' : 'bot');
    d.innerHTML = formatHtml(m.text);
    const meta = document.createElement('div'); meta.className='meta';
    meta.textContent = formatTime(m.ts || Date.now());
    d.appendChild(meta);

    if(m.role !== 'user'){
      const controls = document.createElement('div'); controls.className='msg-controls';
      const readBtn = document.createElement('button'); readBtn.textContent='ðŸ”Š Read'; readBtn.onclick = ()=> speak(m.text);
      const stopBtn = document.createElement('button'); stopBtn.textContent='â¹ Stop'; stopBtn.onclick = ()=> speechSynthesis.cancel();
      controls.append(readBtn, stopBtn);
      d.appendChild(controls);
    }

    chatEl.appendChild(d);
  });
  scrollChat();
}

// render sidebar with search
function renderSidebar(filter = ''){
  chatsListEl.innerHTML = '';
  const list = user ? chats : localMode.chats;
  const filtered = list.filter(c => c.title && c.title.toLowerCase().includes(filter.toLowerCase()));
  filtered.forEach((c, idx) => {
    const item = document.createElement('div');
    item.className = 'chat-item' + (c.id === activeChatId ? ' active' : '');
    const left = document.createElement('div');
    left.style.display='flex'; left.style.flexDirection='column';
    const title = document.createElement('div'); title.textContent = c.title || 'Untitled';
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = c.updatedAt ? new Date(c.updatedAt).toLocaleString() : '';
    left.append(title, meta);

    const right = document.createElement('div');
    const rename = document.createElement('button'); rename.textContent='âœï¸'; rename.title='Rename'; rename.onclick = (e)=>{ e.stopPropagation(); renameChat(c.id); };
    const del = document.createElement('button'); del.textContent='ðŸ—‘ï¸'; del.title='Delete'; del.onclick = (e)=>{ e.stopPropagation(); deleteChat(c.id); };
    right.append(rename, del);

    item.append(left, right);
    item.onclick = ()=> openChat(c.id);
    chatsListEl.appendChild(item);
  });
}

// open chat
async function openChat(id){
  activeChatId = id;
  activeMessages = [];
  renderSidebar(searchInput.value || '');
  if(user){
    const doc = await db.collection('users').doc(user.uid).collection('chats').doc(id).get();
    if(!doc.exists){ activeMessages=[]; renderMessages(activeMessages); return; }
    activeMessages = doc.data().messages || [];
    renderMessages(activeMessages);
  } else {
    const idx = id;
    const record = localMode.chats[idx] || { messages: [] };
    activeMessages = record.messages || [];
    renderMessages(activeMessages);
  }
}

// create new chat
async function createNewChat(title='New chat'){
  if(user){
    const docRef = await db.collection('users').doc(user.uid).collection('chats').add({
      title, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp(), messages: []
    });
    chats.unshift({ id: docRef.id, title });
    activeChatId = docRef.id;
    activeMessages = [];
    renderSidebar(searchInput.value || '');
    renderMessages(activeMessages);
    return docRef.id;
  } else {
    localMode.chats.unshift({ id: localMode.chats.length, title, messages: [] });
    activeChatId = 0;
    activeMessages = [];
    renderSidebar(searchInput.value || '');
    renderMessages(activeMessages);
    return 0;
  }
}

// delete chat
async function deleteChat(id){
  if(!confirm('Delete this chat?')) return;
  if(user){
    await db.collection('users').doc(user.uid).collection('chats').doc(id).delete();
    chats = chats.filter(c=>c.id!==id);
  } else {
    localMode.chats.splice(id,1);
  }
  activeChatId = null;
  activeMessages = [];
  renderSidebar(searchInput.value || '');
  clearChat();
}

// rename chat
async function renameChat(id){
  const newTitle = prompt('Enter new chat title:');
  if(!newTitle) return;
  if(user){
    await db.collection('users').doc(user.uid).collection('chats').doc(id).update({ title: newTitle, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    const meta = chats.find(c=>c.id===id); if(meta) meta.title = newTitle;
  } else {
    const idx = id;
    if(localMode.chats[idx]) localMode.chats[idx].title = newTitle;
  }
  renderSidebar(searchInput.value || '');
}

// save messages for active chat
async function saveActiveMessages(){
  if(!user) return;
  await db.collection('users').doc(user.uid).collection('chats').doc(activeChatId).update({
    messages: activeMessages,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  const meta = chats.find(c=>c.id===activeChatId); if(meta) meta.updatedAt = new Date();
  renderSidebar(searchInput.value || '');
}

// push message
async function pushMessage(role, text){
  const msg = { role: role === 'user' ? 'user' : 'assistant', text, ts: Date.now() };
  activeMessages.push(msg);
  renderMessages(activeMessages);
  if(user){
    await saveActiveMessages();
  } else {
    localMode.chats[activeChatId].messages = activeMessages;
    renderSidebar(searchInput.value || '');
  }
  return msg;
}

// replace thinking placeholder
async function replaceThinkingReply(reply){
  for(let i=activeMessages.length-1;i>=0;i--){
    if(activeMessages[i].role==='assistant' && activeMessages[i].text==='â€¦thinkingâ€¦'){
      activeMessages[i].text = reply; break;
    }
  }
  renderMessages(activeMessages);
  if(user) await saveActiveMessages();
  else localMode.chats[activeChatId].messages=activeMessages;
}

// generate title (first user + first bot)
async function generateTitleIfNeeded(){
  if(!activeMessages || activeMessages.length < 2) return;
  // We want title from first user and first assistant
  const firstUser = activeMessages.find(m=>m.role==='user')?.text || '';
  const firstBot = activeMessages.find(m=>m.role==='assistant' && m.text!=='â€¦thinkingâ€¦')?.text || '';
  if(!firstUser) return;
  const title = (firstUser.trim().slice(0,40) + (firstBot? ' â€” ' + firstBot.trim().slice(0,40):'')).slice(0,80);
  if(user){
    await db.collection('users').doc(user.uid).collection('chats').doc(activeChatId).update({ title, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    const meta = chats.find(c=>c.id===activeChatId); if(meta) meta.title = title;
  } else {
    if(localMode.chats[activeChatId]) localMode.chats[activeChatId].title = title;
  }
  renderSidebar(searchInput.value || '');
}

// serverless proxy call (hides Groq key)
async function callApiChat(message){
  const body = {
    message,
    history: activeMessages.map(m => ({ role: m.role, text: m.text }))
  };
 const response = await fetch("/api/chat", {
    method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
  });
  if(!res.ok){
    const text = await res.text().catch(()=>"");
    throw new Error(text || 'API error');
  }
  const data = await res.json();
  return data.reply;
}

// send flow
async function sendFlow(text, voiceSpeak=false){
  if(activeChatId === null) await createNewChat('New chat');
  // push user
  await pushMessage('user', text);
  // push thinking placeholder
  await pushMessage('assistant','â€¦thinkingâ€¦');
  try{
    const reply = await callApiChat(text);
    await replaceThinkingReply(reply);
    // if first exchange (we can detect by messages count); generate title
    await generateTitleIfNeeded();
    if(voiceSpeak) speak(reply);
  }catch(err){
    console.error(err);
    await replaceThinkingReply('Error contacting chat API.');
  }
}

// TTS
async function waitVoices(){ return new Promise(res=>{ let v = speechSynthesis.getVoices(); if(v.length) return res(v); speechSynthesis.onvoiceschanged = ()=> res(speechSynthesis.getVoices()); }); }
async function speak(text){
  const all = await waitVoices();
  const idx = Number(voiceSelect.value || 0);
  const voice = all[idx] || all.find(v=>v.lang && v.lang.includes('en-GB')) || all[0];
  const u = new SpeechSynthesisUtterance(text.replace(/\*\*/g,''));
  if(voice) u.voice = voice;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

// UI events
sendBtn.onclick = ()=> { const t = inputEl.value.trim(); if(!t) return; inputEl.value=''; sendFlow(t,false); };
inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

// mic
let recognition;
micBtn.onclick = async ()=>{
  if(!('webkitSpeechRecognition' in window)){ alert('Speech recognition not supported'); return; }
  if(!recognition){
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-GB';
    recognition.interimResults = false;
    recognition.onresult = e => { const t = e.results[0][0].transcript; sendFlow(t,true); };
    recognition.onstart = ()=> micBtn.textContent='ðŸŽ™ï¸';
    recognition.onend = ()=> micBtn.textContent='ðŸŽ¤';
  }
  recognition.start();
};

newChatBtn.onclick = ()=> createNewChat('New chat');
modalSignIn.onclick = ()=> signInWithGoogle();
modalSkip.onclick = ()=> { modal.style.display='none'; };
signInBtn.onclick = ()=> signInWithGoogle();
signOutBtn.onclick = ()=> auth.signOut();

async function signInWithGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  try{ await auth.signInWithPopup(provider); modal.style.display='none'; }
  catch(e){ console.error('signin',e); alert('Sign in failed'); }
}

// auth listener
auth.onAuthStateChanged(async u=>{
  user = u;
  if(user){
    signInBtn.style.display='none'; signOutBtn.style.display='inline-block';
    userEmailEl.textContent = user.email || user.displayName || user.uid;
    modal.style.display='none';
    const snap = await db.collection('users').doc(user.uid).collection('chats').orderBy('updatedAt','desc').get();
    chats = snap.docs.map(doc => ({ id: doc.id, title: doc.data().title||'Chat', updatedAt: doc.data().updatedAt?.toDate?.() || new Date() }));
    if(chats.length) activeChatId = chats[0].id;
    renderSidebar(searchInput.value || '');
    if(activeChatId) openChat(activeChatId);
  } else {
    signInBtn.style.display='inline-block'; signOutBtn.style.display='none';
    userEmailEl.textContent = 'not signed';
    modal.style.display = 'flex';
    // setup local sample chat
    localMode = { chats:[ { id:0, title:'Welcome', messages:[ { role:'assistant', text:"Hello â€” I'm URA. Sign in to save chats, or skip to try temporary chat.", ts: Date.now() } ] } ] };
    chats = [];
    activeChatId = 0; activeMessages = [];
    renderSidebar(searchInput.value || '');
    openChat(activeChatId);
  }
});

// search
searchInput.addEventListener('input', ()=> renderSidebar(searchInput.value || ''));

// theme toggle
themeToggle.onclick = ()=> { document.body.classList.toggle('dark'); themeToggle.textContent = document.body.classList.contains('dark')? 'â˜€ï¸':'ðŸŒ™'; };

// bootstrap
(async ()=>{
  setTimeout(()=>{ if(!auth.currentUser) modal.style.display='flex'; },600);
  renderSidebar();
  openChat(0);
  const all = await waitVoices();
  voiceSelect.innerHTML = all.map((v,i)=>`<option value="${i}">${v.name} - ${v.lang}</option>`).join('');
})();
</script>
</body>
</html>
