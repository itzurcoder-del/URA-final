<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>URA Chatbot</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<style>
:root {
  --bg:#f5f5f5;--text:#111;--bubble:#fff;--user:#0ea5e9;--bot:#22c55e;
}
body.dark {
  --bg:#0d1117;--text:#e6edf3;--bubble:#161b22;--user:#60a5fa;--bot:#4ade80;
}
body {margin:0;font-family:system-ui,Arial;height:100vh;display:flex;background:var(--bg);color:var(--text);overflow:hidden;}
#container{display:flex;width:100%;}
aside{width:250px;background:var(--bubble);display:flex;flex-direction:column;transition:transform .3s;box-shadow:2px 0 6px rgba(0,0,0,.2);}
aside header{display:flex;justify-content:space-between;align-items:center;padding:10px;}
#chatList{flex:1;overflow-y:auto;}
.chat-item{padding:10px;border-bottom:1px solid #ddd;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.chat-item:hover{background:#e0e0e0;}
main{flex:1;display:flex;flex-direction:column;}
#mainHeader{display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--bubble);}
#chat{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:10px;}
.msg{padding:10px 14px;border-radius:14px;max-width:80%;animation:fadeIn .3s ease;}
.user{background:var(--user);color:#fff;align-self:flex-end;}
.bot{background:var(--bot);color:#fff;align-self:flex-start;}
.controls{display:flex;gap:8px;background:var(--bubble);padding:10px;}
textarea{flex:1;resize:none;border:none;border-radius:50px;padding:10px;outline:none;height:45px;}
button{border:none;border-radius:20px;padding:8px 12px;cursor:pointer;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
@media(max-width:768px){aside{position:fixed;top:0;bottom:0;left:0;transform:translateX(-100%);z-index:999;}
aside.open{transform:translateX(0);}#toggleSidebar{display:block;}}
.timestamp{font-size:12px;opacity:.6;margin-top:4px;text-align:right;}
footer{padding:10px;border-top:1px solid #ccc;}
</style>
</head>
<body>
<div id="container">
  <aside id="sidebar">
    <header>
      <h2>URA</h2>
      <button id="newChat">ï¼‹</button>
    </header>
    <input id="search" placeholder="Search chats..." style="margin:8px;padding:6px;border-radius:6px;border:1px solid #ccc;">
    <div id="chatList"></div>
    <footer>
      <button id="loginBtn">Login with Google</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </footer>
  </aside>

  <main>
    <header id="mainHeader">
      <button id="toggleSidebar">â˜°</button>
      <h3 id="chatTitle">New Chat</h3>
      <button id="themeToggle">ðŸŒ™</button>
    </header>

    <div id="chat"></div>

    <div class="controls">
      <button id="mic">ðŸŽ¤</button>
      <textarea id="input" placeholder="Type a message..."></textarea>
      <button id="send">Send</button>
    </div>
  </main>
</div>

<script>
const GROQ_API_KEY="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";
const GROQ_URL="https://api.groq.com/openai/v1/chat/completions";

const firebaseConfig = {
  apiKey: "AIzaSyAfbJJEw61oIaMKUIFMGVK062g376dSrXI",
  authDomain: "ura-ai-b1b20.firebaseapp.com",
  projectId: "ura-ai-b1b20",
  storageBucket: "ura-ai-b1b20.firebasestorage.app",
  messagingSenderId: "330104435643",
  appId: "1:330104435643:web:6f1d6f338a2e0de6cb0a9e"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const chatDiv=document.getElementById("chat");
const input=document.getElementById("input");
const sendBtn=document.getElementById("send");
const micBtn=document.getElementById("mic");
const themeBtn=document.getElementById("themeToggle");
const chatList=document.getElementById("chatList");
const newChatBtn=document.getElementById("newChat");
const toggleSidebar=document.getElementById("toggleSidebar");
const chatTitle=document.getElementById("chatTitle");
const search=document.getElementById("search");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");

let chats=JSON.parse(localStorage.getItem("ura_chats")||"[]");
let currentChat=null;
let user=null;

function renderChats(filter=""){
  chatList.innerHTML="";
  chats.filter(c=>c.title.toLowerCase().includes(filter.toLowerCase())).forEach((c,i)=>{
    const div=document.createElement("div");
    div.className="chat-item";
    const name=document.createElement("span");
    name.textContent=c.title||"New Chat";
    name.onclick=()=>openChat(i);
    const tools=document.createElement("div");
    const rename=document.createElement("button");rename.textContent="âœï¸";rename.onclick=e=>{e.stopPropagation();renameChat(i);};
    const del=document.createElement("button");del.textContent="ðŸ—‘ï¸";del.onclick=e=>{e.stopPropagation();deleteChat(i);};
    tools.append(rename,del);
    div.append(name,tools);
    chatList.appendChild(div);
  });
}
renderChats();
search.oninput=()=>renderChats(search.value);

function append(role,text){
  const d=document.createElement("div");
  d.className="msg "+role;
  d.innerHTML=`<div>${text}</div><div class="timestamp">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
  chatDiv.appendChild(d);
  chatDiv.scrollTop=chatDiv.scrollHeight;
}

async function sendFlow(){
  const text=input.value.trim();
  if(!text)return;
  append("user",text);
  input.value="";
  append("bot","â€¦thinkingâ€¦");
  try{
    const res=await fetch(GROQ_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json",Authorization:`Bearer ${GROQ_API_KEY}`},
      body:JSON.stringify({model:"llama-3.1-70b-versatile",messages:[{role:"user",content:text}]})
    });
    const data=await res.json();
    chatDiv.querySelector(".bot:last-child").remove();
    const reply=data.choices?.[0]?.message?.content||"No reply.";
    append("bot",reply);
    if(!currentChat){
      const name=text.slice(0,15)+(text.length>15?"â€¦":"");
      chats.push({title:name,messages:[]});
      currentChat=chats.length-1;
    }
    chats[currentChat].messages.push({role:"user",text});
    chats[currentChat].messages.push({role:"bot",text:reply});
    localStorage.setItem("ura_chats",JSON.stringify(chats));
    renderChats();
  }catch(e){
    console.error(e);
    alert("Groq error");
  }
}

sendBtn.onclick=sendFlow;
toggleSidebar.onclick=()=>document.querySelector("aside").classList.toggle("open");
newChatBtn.onclick=()=>{currentChat=null;chatDiv.innerHTML="";chatTitle.textContent="New Chat";};
function openChat(i){
  currentChat=i;
  chatTitle.textContent=chats[i].title;
  chatDiv.innerHTML="";
  chats[i].messages.forEach(m=>append(m.role,m.text));
  document.querySelector("aside").classList.remove("open");
}
function renameChat(i){
  const n=prompt("Rename chat:",chats[i].title);
  if(n){chats[i].title=n;localStorage.setItem("ura_chats",JSON.stringify(chats));renderChats();}
}
function deleteChat(i){
  if(confirm("Delete chat?")){chats.splice(i,1);localStorage.setItem("ura_chats",JSON.stringify(chats));renderChats();}
}

micBtn.onclick=()=>{
  if(!('webkitSpeechRecognition'in window)){alert("Speech recognition not supported");return;}
  const rec=new webkitSpeechRecognition();
  rec.lang="en-GB";
  rec.start();
  rec.onresult=e=>{
    const t=e.results[0][0].transcript;
    input.value=t;
    sendFlow();
  };
};

themeBtn.onclick=()=>{
  document.body.classList.toggle("dark");
  themeBtn.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ðŸŒ™";
};

loginBtn.onclick=()=>{
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(u=>{
  user=u;
  if(u){loginBtn.style.display="none";logoutBtn.style.display="block";}
  else{loginBtn.style.display="block";logoutBtn.style.display="none";}
});
</script>
</body>
</html>
